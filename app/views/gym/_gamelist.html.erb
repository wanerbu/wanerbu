<%
  reservation_type = @court.reservation_type 
  gym = Gym.find(@court.gym_id) 
  open_time= gym.open_time
  close_time = gym.close_time
%>
<div class="seatGroup mt20">
  <div class="ui_left">
    <%if reservation_type  == "according_time" then%>
      <div class="seatViewTitle">
        <div class="seatViewInfo">
          <ul>
            <li><span class="hasSeat"></span>可预订</li>
            <li><span class="sellSeat"></span>已占用</li>
            <li><span class="checkSeat"></span>已选场次</li>
          </ul>
        </div>
      </div><!--view title-->
    <%end%>
    <div class="mod_tabs mt40">
      <div class="mod_hd">
        <ul class="nav nav-tabs">
          <% for i in 0..10 %>
            <li class="<%= 'active' if Date.today+i == params[:date].to_date %>">
            <a href="javascript:searchgame('<%=@court.id%>', '<%=Date.today+i%>');">
              <% if i == 0 %>
                今天
              <%elsif i == 1 %>
                明天
              <%else%>
                <%= (Date.today+i).strftime("%m/%d")%>&nbsp;<%= show_week(Date.today+i)%>
              <%end%>
            </a>
            </li>
          <%end%>
        </ul>
      </div>
      <div class="mod_bd">
        <div class="inner">
          <div class="inner_table">
            <dl class="<%= reservation_type  == "according_time" ? 'has_pk' : 'has_pk_p'%>">
              <dt>
              <% @court.games.all.each do |game|%>
                <span><%= game.name%></span>
              <%end%>
              </dt>
              <%if reservation_type  == "according_time" then%>
                <dd>
                <%
                  min_unit = @court.min_unit
                  if Date.today == params[:date].to_date
                    t = Time.now
                    h = t.hour
                    if t.min >= 30
                      h = h + 3
                    else
                      h = h + 2
                    end
                    if h > 24
                      h = 24
                    end
                    open_time = Time.utc(open_time.year,open_time.month,open_time.day,h,open_time.min,open_time.sec)
                  end
                %>
                <div class="pk_table">
                  <div class="pk_rows">
                    <%
                      (open_time.to_time.utc.to_i .. close_time.to_time.utc.to_i- (min_unit * 3600)).step(min_unit.hour).each do |time|%>
                        <div class="pk_cols"><em> <%= Time.at(time).utc.strftime('%H:%M')%></em></div>
                      <%end%>
                    </div>
                    <%
                      arg = Hash.new()
                      arg["open_time"] = open_time
                      arg["close_time"] = close_time
                      arg["min_unit"] = min_unit
                      arg["reservation_type"] = reservation_type
                    %>
                    <%
                      @court.games.all.each do |game|
                        arg["game_id"] = game.id
                        hs = get_fix_price_reservation(arg,params[:date].to_date)
                      %>
                      <div class="pk_rows">
                        <% hs.each_cons(2) {|(key,value),(next_key,next_value)|%>
                          <div class="pk_cols">
                            <% arr = value.to_a %>
                            <% if arr[1]#可以预订
                            selectid = game.id.to_s + params[:date].delete("-") + key.delete(":")
                            s_time = Time.parse(params[:date].to_s + " " + key.to_s + ":00")
                            e_time = Time.parse(params[:date].to_s + " " + next_key.to_s + ":00")
                          %>
                          <%if !game.has_reservation(s_time,e_time) #没有预订%>
                            <span onclick='return select(<%=selectid%>,<%=game.id%>)' id="<%=selectid%>" title="<%= key + '-' + next_key + ' ' + game.name + ' ' + arr[0].to_s + ' '%>元" price="<%=arr[0]%>" start_time ="<%=s_time%>" end_time="<%=e_time%>" class="hasSeat">
                              <%=arr[0]%>元
                            <%else%>
                              <span title="该场次已售出" class="sellSeat">
                              <%end%>
                            <% else %>
                              <span title="该场次已售出" class="sellSeat">
                              <%end%>
                            </span>
                          </div>
                        <%}%>
                      </div>
                    <%end%>
                    </dd>
                  <%else%> <!--按场次-->
                    <dd>
                    <div class="pk_table_p">
                      <%@court.games.all.each do |game|%>
                        <div class="pk_rows_p">
                          <div class="pk_cols_p">
                            <%hs = get_fix_price_reservation_for_people(game.id,params[:date].to_date)
                            arr = hs["allday"].to_a
                            selectid = game.id.to_s + params[:date].delete("-") 
                            lang = open_time.strftime('%H:%M') + "-" + close_time.strftime('%H:%M')+ " " + game.name + " "+ arr[0].to_s + "元每人不限时"
                            s_time = Time.parse(params[:date].to_s + " " + open_time.strftime('%H:%M')  + ":00")
                            e_time = Time.parse(params[:date].to_s + " " + close_time.strftime('%H:%M') + ":00")
                            remain_people_num = game.get_remain_people_num(s_time)
                          %>
                          <span class=<%="select" if remain_people_num > 0%> id="<%=selectid%>" price="<%=arr[0]%>" lang="<%=lang%>" start_time ="<%=s_time%>" end_time="<%=e_time%>" >
                            <%=game.name%><br>
                            <%=open_time.strftime('%H:%M')%>-<%=close_time.strftime('%H:%M')%><br>
                            <%=arr[0]%> 元每人不限时
                          </span>
                        </div><!--cols-->
                        <div class="pk_cols_p">
                          <% if remain_people_num > 0%>
                            <div class="left">请选择人数</div>
                            <div class="left">
                              <div class="left">
                                <select onchange="select_p(<%=selectid%>,<%=game.id%>)" id="<%="select"+selectid%>">
                                  <option>0</option>
                                  <%if remain_people_num >= 10 %>
                                    <option>0</option>
                                    <option>1</option>
                                    <option>2</option>
                                    <option>3</option>
                                    <option>4</option>
                                  </select>
                                </div>
                                <div class="left"> <em>场次充足</em></div>
                              <%else%>
                                <% if remain_people_num >= 4%>
                                  <option>1</option>
                                  <option>2</option>
                                  <option>3</option>
                                  <option>4</option>
                                </select>
                              </div>
                            <%else%>
                              <% if remain_people_num >= 1%>
                                <%for i in 1..remain_people_num%>
                                  <option><%=i%></option>
                                <%end%>
                              <%end%>
                            </select>
                          </div>
                        <%end%>
                        <div class="left"> <em>剩余<%=remain_people_num%>人</em></div>
                      <%end%>
                    </div>
                    <input id="<%="pre"+selectid%>" type="hidden" value="0" name="<%="pre"+selectid%>">
                  <%else%>
                    <div class="left"> <em>名额已满,暂不能预订</em></div>
                  <%end%>
                </div><!--cols-->
              </div><!--rows-->
            <%end%>
          </div><!--table-->
          </dd>
        <%end%>
      </dl>
    </div>
  </div>
</div>
  </div>
</div><!--ui_left-->
<%= form_tag({:controller => "gym", :action => "submit_order"}, {:method => "post",:id => 'orderform'}) do %>
  <div id="orderform" class="ui_right">
    <div class="innder">
      <div class="pewSeat">
        <p class="bold fs14"><a href=""><%=gym.name%></a></p>
        <p class="mt10"><em>预订项目：</em><b>
          <%= Sport.find(@court.sport_id).name + "(" + @court.reservation_type.text + ")"%></b></p>
        <p><em>日期：</em><span class="cred fs14"><%=params[:date].to_date.strftime("%y-%m-%d")%>&nbsp;<%= show_week(params[:date].to_date)%></span></p>
      </div>
      <div class="choose_games_txt">场次：</div>
      <div id="cancelSite" style="display: block;" >
        <span class="pews">还未选择场次</span>
        <p>
        <span class="cf60">单击左侧选择场次</span></p>
      </div>
      <div id="hasSiteBox" style="display: none;">
      </div>
      <div id="hasSiteInfo" style="display: none; float: left;">
      </div>
      <div class="rightBox">
        <p>输入接收短信的手机号码</p>
        <div class="mobileInfo mt10">
          <p><em>手机号：</em></p>
          <p>
          <input id="telephone_no" type="text" class="pho-text" placeholder="请输入您的手机号" name="order[telephone_no]">
          <span class="cred">*</span>
          </p>
          <p class="mt5"><em>验证码：</em></p>
          <p>
          <input class="vla-text" type="text">
          <span class="cred">*</span>
          </p>
          <p class="ml10">
          <%if reservation_type  == "according_time" %>
            <%= submit_tag(t('views.defaults.actions.submit_order'),:onclick => "return validateform();") %>
          <%else%>
            <%= submit_tag(t('views.defaults.actions.submit_order'),:onclick => "return validateform_p();") %>
          <%end%>
          </p>
        </div>
      </div>
    </div>
    <input id="user_id" type="hidden" value="<%=current_user.nil? ? " " : current_user.id%>" name="order[user_id]">
    <!--
    <input id="user_id" type="hidden" value="1" name="order[user_id]">
    -->
  </div><!--ui_right-->
<%end%>
  </div><!--seatGroup-->
  <form id="forCtrl">
    <input id="peoplesInput" type="hidden" value="0" name="peoplesInput">
    <input id="timesInput" type="hidden" value="0" name="timesInput">
    <input id="priceInput" type="hidden" value="0" name="priceInput">
  </form>
  <!-- Modal -->
  <%= form_for(resource, :as => resource_name, :url => session_path(resource_name)) do |f| %>
    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">玩儿不网登录</h4>
          </div>
          <div class="modal-body">
            <div><%= f.label :login %><br />
              <%= f.text_field :login %></div>

            <div><%= f.label :password %><br />
              <%= f.password_field :password %></div>

            <% if devise_mapping.rememberable? -%>
            <div><%= f.check_box :remember_me %> <%= f.label :remember_me %></div>
            <% end -%>
          </div>
          <div class="modal-footer">
            <div><%= f.submit "Sign in" %></div>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <% end %>

    <div class="modal fade" id="checkorderModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="checkouderModalLabel">玩儿不网提示</h4>
          </div>
          <div class="modal-body">
            <div style="font-size: 14px;margin-bottom: 10px;">对不起！你所选的以下场次已被其他用户暂时抢占，系统将会自动释放你的选择，请重新选择!</div>
            <div id="checkedHas" >

            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">我知道了</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
